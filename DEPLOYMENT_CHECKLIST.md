# Deployment Checklist

## ‚úÖ Backend Changes Completed

- [x] Updated `src/config/contract.ts` with `SNAPSHOT_FACTORY` and `royaltyRecipient`
- [x] Added `getNextSnapshotId()` method to `contractService`
- [x] Added `getCurrentBlockNumber()` method to `contractService`
- [x] Enhanced `prepareMintSnapshot` controller to generate all data
- [x] Updated route to accept `beneficiaryIndex` query parameter
- [x] Added `/api/snapshot-minted` webhook endpoint
- [x] All lint checks passing ‚úì
- [x] Complete documentation created

## üìã Pre-Deployment Checklist

### Environment Configuration
- [ ] Add `SNAPSHOT_FACTORY=0xYourAddress` to `.env`
- [ ] Verify `SNAPSHOT_NFT_ADDRESS` is set (needed for getNextSnapshotId)
- [ ] Verify `DISTRIBUTOR_ADDRESS` is set (needed for beneficiary lookup)
- [ ] Set `ROYALTY_RECIPIENT` (optional, defaults to 0xe39C834603f50FFd4eEbf35437a0770CA90a9ACd)
- [ ] Set `IMAGE_GENERATION_SERVICE_URL` (optional, defaults to https://wof.up.railway.app)

### Backend Testing
- [ ] Test GET endpoint without beneficiaryIndex: `curl http://localhost:3001/api/write/snapshots/mint/1`
- [ ] Test GET endpoint with beneficiaryIndex: `curl 'http://localhost:3001/api/write/snapshots/mint/1?beneficiaryIndex=0'`
- [ ] Verify response includes: `processId`, `snapshotId`, `blockNumber`
- [ ] Verify response includes beneficiary data when index provided
- [ ] Test webhook endpoint with sample data
- [ ] Check backend logs for data generation messages

### Frontend Updates Needed
- [ ] Update GET request URL to include `?beneficiaryIndex=${index}`
- [ ] Store entire response `data` object from GET request
- [ ] Remove frontend `processId` generation code
- [ ] Remove frontend `snapshotId` estimation code
- [ ] Remove frontend distribution calculation code
- [ ] Update contract call to use `data.processId` (not generated)
- [ ] Update contract call to use `data.args.beneficiaryIndex` (from backend)
- [ ] Update webhook call to relay backend data:
  - `contractAddress` from backend
  - `seedId` from backend
  - `snapshotId` from backend
  - `beneficiaryCode` from backend
  - `beneficiaryDistribution` from backend
  - `processId` from backend (exact same value!)
  - `blockNumber` from backend
- [ ] Only frontend-provided values: `creator` (user address) and `txHash`

### Testing on Testnet
- [ ] Deploy backend to testnet environment
- [ ] Update frontend to use new API format
- [ ] Test full mint flow on testnet
- [ ] Verify processId matches between contract call and webhook
- [ ] Verify image generation receives correct data
- [ ] Check that snapshot ID matches contract's next ID
- [ ] Verify distribution percentage is correct
- [ ] Test with different beneficiaries

### Production Deployment
- [ ] Update production `.env` with mainnet addresses
- [ ] Deploy backend changes
- [ ] Deploy frontend changes
- [ ] Test with small transaction first
- [ ] Monitor logs for any errors
- [ ] Verify image generation is working
- [ ] Check webhook responses

## üîç Verification Tests

### Test 1: Backend Data Generation
```bash
curl 'http://localhost:3001/api/write/snapshots/mint/1?beneficiaryIndex=0'
```

**Expected Response:**
```json
{
  "success": true,
  "data": {
    "contractAddress": "0x...",
    "functionName": "mintSnapshot",
    "args": {
      "seedId": 1,
      "beneficiaryIndex": 0,
      "royaltyRecipient": "0x..."
    },
    "value": "...",
    "valueEth": "...",
    "processId": "1234567890-abc123",     // ‚úì Generated by backend
    "snapshotId": 42,                      // ‚úì From contract
    "blockNumber": 1000001,                // ‚úì From provider
    "beneficiaryCode": "01-GRG",          // ‚úì From contract
    "beneficiaryDistribution": 25.5        // ‚úì Calculated
  }
}
```

### Test 2: Webhook Reception
```bash
curl -X POST http://localhost:3001/api/snapshot-minted \
  -H "Content-Type: application/json" \
  -d '{
    "contractAddress": "0x...",
    "seedId": 1,
    "snapshotId": 42,
    "beneficiaryCode": "01-GRG",
    "beneficiaryDistribution": 25.5,
    "creator": "0x...",
    "txHash": "0x...",
    "timestamp": 1690000000,
    "blockNumber": 1000001,
    "processId": "1234567890-abc123"
  }'
```

**Expected:** Should forward to image generation service successfully

## üêõ Common Issues & Solutions

### Issue: "Seed not found"
**Solution:** Verify `SEED_FACTORY_ADDRESS` and `SEED_NFT_ADDRESS` are correct

### Issue: "Beneficiary not found"
**Solution:** Verify `DISTRIBUTOR_ADDRESS` is correct and beneficiaryIndex exists

### Issue: "getNextSnapshotId is not a function"
**Solution:** Verify `SNAPSHOT_NFT_ADDRESS` is set and contract is deployed

### Issue: processId mismatch in logs
**Solution:** Ensure frontend uses exact `data.processId` from GET response

### Issue: Incorrect distribution percentage
**Solution:** Check that all seed snapshots are being fetched correctly

## üìä Monitoring

After deployment, monitor:
- [ ] Backend logs for processId generation
- [ ] Contract calls with correct arguments
- [ ] Webhook calls with matching data
- [ ] Image generation service responses
- [ ] Any error patterns in logs

## üéØ Success Criteria

A successful deployment means:
1. ‚úì GET endpoint returns all required data
2. ‚úì processId is generated by backend, not frontend
3. ‚úì snapshotId matches contract's next ID
4. ‚úì Beneficiary code and distribution are accurate
5. ‚úì Frontend successfully calls contract with backend data
6. ‚úì Webhook receives correct data from frontend
7. ‚úì Image generation service processes the request
8. ‚úì Snapshot NFT is minted correctly
9. ‚úì All data is consistent across the flow

## üìö Reference Documentation

- Full API Documentation: `SNAPSHOT_MINTING_API.md`
- Configuration Guide: `CONFIGURATION_GUIDE.md`
- Quick Reference: `QUICK_REFERENCE.md`
- Architecture Changes: `BACKEND_IMPROVEMENTS.md`
- Complete Summary: `FINAL_SUMMARY.md`

## üöÄ Ready to Deploy?

Once all checklist items are complete:
1. Run `npm run build` to verify compilation
2. Deploy backend
3. Update frontend
4. Test on testnet
5. Deploy to production
6. Monitor and celebrate! üéâ

---

**Last Updated:** After implementing backend data generation improvements  
**Status:** ‚úÖ Backend ready for deployment  
**Next:** Frontend updates to use new API format

