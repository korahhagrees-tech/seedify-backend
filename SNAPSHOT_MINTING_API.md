# Snapshot Minting API Documentation

## Overview
This document describes the new snapshot minting flow that uses the `mintSnapshot` function on the SnapFactory contract instead of the `depositForSeed` function.

## New Environment Variables

Add these to your `.env` file:

```env
# SnapFactory contract address (for minting snapshots)
SNAPSHOT_FACTORY=0xYourSnapFactoryAddress

# Royalty recipient address (receives 10% fee on snapshot mints)
# Defaults to 0xe39C834603f50FFd4eEbf35437a0770CA90a9ACd
ROYALTY_RECIPIENT=0xe39C834603f50FFd4eEbf35437a0770CA90a9ACd

# External image generation service URL
# Defaults to https://wof.up.railway.app
IMAGE_GENERATION_SERVICE_URL=https://wof.up.railway.app
```

## API Endpoints

### 1. Prepare Mint Snapshot (GET)
**Endpoint:** `GET /api/write/snapshots/mint/:seedId?beneficiaryIndex=0`

**Description:** Generates ALL necessary data for the frontend to execute the `mintSnapshot` transaction and subsequent webhook. The backend generates processId, fetches next snapshot ID, current block number, beneficiary code, and calculates distribution.

**Request Parameters:**
- `seedId` (path parameter): The ID of the seed to mint a snapshot for
- `beneficiaryIndex` (query parameter, optional): The index of the beneficiary (if provided, includes beneficiary-specific data)

**Response (without beneficiaryIndex):**
```json
{
  "success": true,
  "data": {
    "contractAddress": "0xSnapFactoryAddress",
    "functionName": "mintSnapshot",
    "args": {
      "seedId": 1,
      "royaltyRecipient": "0xe39C834603f50FFd4eEbf35437a0770CA90a9ACd"
    },
    "value": "1000000000000000000",
    "valueEth": "1.0",
    "description": "Mint snapshot for seed 1",
    "seedOwner": "0xSeedOwnerAddress",
    "processId": "1234567890-abc123def",
    "snapshotId": 42,
    "blockNumber": 1000001
  },
  "message": "Transaction data prepared. Frontend should execute the transaction with these exact values.",
  "timestamp": 1234567890
}
```

**Response (with beneficiaryIndex):**
```json
{
  "success": true,
  "data": {
    "contractAddress": "0xSnapFactoryAddress",
    "functionName": "mintSnapshot",
    "args": {
      "seedId": 1,
      "beneficiaryIndex": 0,
      "royaltyRecipient": "0xe39C834603f50FFd4eEbf35437a0770CA90a9ACd"
    },
    "value": "1000000000000000000",
    "valueEth": "1.0",
    "description": "Mint snapshot for seed 1",
    "seedOwner": "0xSeedOwnerAddress",
    "processId": "1234567890-abc123def",
    "snapshotId": 42,
    "blockNumber": 1000001,
    "beneficiaryCode": "01-GRG",
    "beneficiaryDistribution": 25.5
  },
  "message": "Transaction data prepared. Frontend should execute the transaction with these exact values.",
  "timestamp": 1234567890
}
```

**Frontend Usage:**
The frontend should:
1. Call this endpoint with the selected beneficiaryIndex
2. Receive all data from backend (including processId, snapshotId, blockNumber, beneficiaryCode, distribution)
3. Get the user's wallet address for the `to` parameter
4. Call the contract with the provided data:
   ```javascript
   // All data is provided by the backend - frontend just uses it
   const tx = await writeContract({
     address: data.contractAddress,
     abi: SnapFactoryAbi,
     functionName: 'mintSnapshot',
     args: [
       data.args.seedId,                // seedId (from backend)
       data.args.beneficiaryIndex,      // beneficiaryIndex (from backend)
       data.processId,                   // process (generated by backend)
       userAddress,                      // to (user's wallet address - only frontend-provided value)
       data.args.royaltyRecipient       // royaltyRecipient (from backend)
     ],
     value: BigInt(data.value)
   });
   ```
5. After transaction confirms, send ALL the backend-provided data to the webhook (backend will recognize it)

### 2. Snapshot Minted Webhook (POST)
**Endpoint:** `POST /api/snapshot-minted`

**Description:** Called by the frontend after a successful snapshot mint to trigger image generation.

**Request Body:**
```json
{
  "contractAddress": "0xSnapFactoryAddress",
  "seedId": 10,
  "snapshotId": 1,
  "beneficiaryCode": "01-GRG",
  "beneficiaryDistribution": 25.5,
  "creator": "0xUserAddress",
  "txHash": "0xTransactionHash",
  "timestamp": 1690000000,
  "blockNumber": 1000001,
  "processId": "1234567890-abc12"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Snapshot minted webhook processed successfully",
  "data": {
    // Response from image generation service
  },
  "timestamp": 1234567890
}
```

**Frontend Usage:**
After the transaction is confirmed, send the data back to this endpoint. Most values should come from the GET response, not generated by frontend:
- `contractAddress`: from GET response `data.contractAddress`
- `seedId`: from GET response `data.args.seedId`
- `snapshotId`: from GET response `data.snapshotId`
- `beneficiaryCode`: from GET response `data.beneficiaryCode`
- `beneficiaryDistribution`: from GET response `data.beneficiaryDistribution`
- `creator`: user's wallet address (same as used in contract `to` parameter)
- `txHash`: from the transaction receipt
- `timestamp`: current timestamp in seconds (Math.floor(Date.now() / 1000))
- `blockNumber`: from GET response `data.blockNumber` OR from transaction receipt
- `processId`: from GET response `data.processId` (IMPORTANT: use exact same value)

## Contract Function Signature

```solidity
function mintSnapshot(
    uint256 seedId,
    uint256 beneficiaryIndex,
    string memory process,
    address to,
    address royaltyRecipient
) external payable returns (uint256)
```

**Parameters:**
- `seedId`: The ID of the seed NFT
- `beneficiaryIndex`: The index of the beneficiary
- `process`: The process ID (unique identifier for the snapshot)
- `to`: The address to mint the snapshot NFT to (user's address)
- `royaltyRecipient`: The address to receive 10% royalty fee (if `address(0)`, fee goes to SnapFactory)

**Returns:** The newly minted snapshot ID

## Integration Flow

```
1. User selects seed and beneficiary
   ↓
2. Frontend calls GET /api/write/snapshots/mint/:seedId?beneficiaryIndex=X
   ↓
3. Backend generates and returns ALL data:
   - processId (unique, generated by backend)
   - snapshotId (next ID from contract)
   - blockNumber (current block)
   - beneficiaryCode (looked up from contract)
   - beneficiaryDistribution (calculated from snapshots)
   - contract address, value, royaltyRecipient
   ↓
4. Frontend gets user's wallet address
   ↓
5. Frontend calls mintSnapshot on SnapFactory contract using backend-provided data
   ↓
6. Transaction is confirmed
   ↓
7. Frontend calls POST /api/snapshot-minted
   - Sends back the SAME data received from GET endpoint
   - Only adds: creator (user address) and txHash
   ↓
8. Backend forwards request to image generation service
   ↓
9. Image is generated and stored using the processId
```

**Key Point:** The backend generates the processId, snapshotId, beneficiaryCode, distribution, and blockNumber. The frontend simply relays this data back after the transaction. This ensures consistency and reduces frontend complexity.

## Example Frontend Implementation

See `src/services/useMintSnapshot.ts` for a complete React hook implementation that follows this flow.

## Notes

- The `royaltyRecipient` is set via environment variable and defaults to `0xe39C834603f50FFd4eEbf35437a0770CA90a9ACd`
- The `processId` must be unique for each snapshot mint and should be the same value used in both the contract call and the webhook call
- The `to` address should be the user's wallet address who is minting the snapshot
- The backend acts as a relay, forwarding the webhook to the external image generation service

## Error Handling

All endpoints return standard error responses:

```json
{
  "success": false,
  "error": "Error type",
  "message": "Detailed error message",
  "timestamp": 1234567890
}
```

Common error codes:
- `400`: Bad request (invalid parameters)
- `404`: Seed not found
- `500`: Internal server error or external service error

