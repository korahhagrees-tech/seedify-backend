# Snapshot Minting Quick Reference

## üîë Required Environment Variables

```env
SNAPSHOT_FACTORY=0xYourSnapFactoryAddress
ROYALTY_RECIPIENT=0xe39C834603f50FFd4eEbf35437a0770CA90a9ACd  # Optional, this is the default
```

## üéØ API Endpoints

### 1. Prepare Mint (GET)
```
GET /api/write/snapshots/mint/:seedId?beneficiaryIndex=0
```
Returns ALL transaction data including processId, snapshotId, blockNumber, beneficiaryCode, and distribution calculated by backend.

### 2. Snapshot Minted Webhook (POST)
```
POST /api/snapshot-minted
```
Triggers image generation after successful mint.

## üìù Contract Function

```solidity
mintSnapshot(
  uint256 seedId,
  uint256 beneficiaryIndex,
  string memory process,      // Unique ID generated by frontend
  address to,                  // User's wallet address
  address royaltyRecipient    // From ROYALTY_RECIPIENT env var
) payable
```

## üîÑ Integration Flow

```
1. GET /api/write/snapshots/mint/:seedId?beneficiaryIndex=X
   ‚Üì
2. Backend generates processId, snapshotId, beneficiaryCode, etc.
   ‚Üì
3. Frontend calls mintSnapshot on contract with backend data
   ‚Üì
4. POST /api/snapshot-minted (relay backend data + txHash)
   ‚Üì
5. Image generated with processId
```

**Important:** Backend generates processId, snapshotId, and all other data. Frontend just relays it!

## üìã POST /api/snapshot-minted Body

```json
{
  "contractAddress": "from GET response",
  "seedId": "from GET response",
  "snapshotId": "from GET response",
  "beneficiaryCode": "from GET response",
  "beneficiaryDistribution": "from GET response",
  "creator": "user's wallet address",
  "txHash": "from transaction receipt",
  "timestamp": "current unix seconds",
  "blockNumber": "from GET response (or tx receipt)",
  "processId": "from GET response (MUST match!)"
}
```

**Key:** Almost all values come from the GET endpoint response!

## ‚ö†Ô∏è Important Notes

- **Backend generates processId** - frontend must use the exact value from GET response
- **Backend calculates distribution** - no need for frontend calculation
- **Backend fetches next snapshotId** - from contract's getNextSnapshotId()
- **to** address in contract call should be the user's wallet address (only frontend-provided value)
- **beneficiaryDistribution** is a percentage calculated by backend (e.g., 25.5 for 25.5%)
- **timestamp** should be in seconds, not milliseconds
- **royaltyRecipient** receives 10% of the snapshot price

## üîç Testing

```bash
# Test prepare mint (with beneficiary)
curl http://localhost:3001/api/write/snapshots/mint/1?beneficiaryIndex=0

# Test prepare mint (without beneficiary - partial data)
curl http://localhost:3001/api/write/snapshots/mint/1

# Test webhook (data should match GET response)
curl -X POST http://localhost:3001/api/snapshot-minted \
  -H "Content-Type: application/json" \
  -d '{"contractAddress":"0xdev","seedId":10,"snapshotId":42,"beneficiaryCode":"01-GRG","beneficiaryDistribution":25.5,"creator":"0xowner","txHash":"0xabc123","timestamp":1690000000,"blockNumber":1000001,"processId":"1234567890-abc123def"}'
```

## üìö Documentation

- Full API docs: `SNAPSHOT_MINTING_API.md`
- Configuration: `CONFIGURATION_GUIDE.md`
- All changes: `CHANGES_SUMMARY.md`
- Frontend example: `src/services/useMintSnapshot.ts`

## üêõ Common Errors

| Error | Solution |
|-------|----------|
| "Seed not found" | Check SEED_FACTORY_ADDRESS and seedId |
| "Missing required fields" | Verify all fields in POST body |
| "Image generation service error" | Check IMAGE_GENERATION_SERVICE_URL |
| Contract revert | Verify snapshot price value is correct |

## üöÄ Quick Start

1. Add `SNAPSHOT_FACTORY` to `.env`
2. Update frontend to:
   - Call GET endpoint with beneficiaryIndex query param
   - Store ALL response data
   - Use backend-provided processId (don't generate your own!)
   - Call contract with backend data + user address
   - Call POST webhook with backend data + txHash
3. Test on testnet
4. Deploy to production

## üí° Frontend Implementation Checklist

- [ ] Get beneficiary index from user selection
- [ ] Call GET `/api/write/snapshots/mint/:seedId?beneficiaryIndex=X`
- [ ] Store the entire response data object
- [ ] Get user's wallet address
- [ ] Call `mintSnapshot` on SnapFactory contract with:
  - `args: [data.args.seedId, data.args.beneficiaryIndex, data.processId, userAddress, data.args.royaltyRecipient]`
  - `value: data.value`
- [ ] Wait for transaction confirmation and get txHash
- [ ] Call POST `/api/snapshot-minted` with:
  - All values from GET response (contractAddress, seedId, snapshotId, beneficiaryCode, beneficiaryDistribution, processId, blockNumber)
  - Plus: creator (user address) and txHash (from transaction)
- [ ] ‚ö†Ô∏è CRITICAL: Use the EXACT processId from GET response, don't generate a new one!

## üîê Security Notes

- Keep `.env` file secure
- Never expose ROYALTY_RECIPIENT private key
- Validate user inputs before calling contract
- Handle errors gracefully
- Log all transactions for auditing

---

**Need Help?** Check the full documentation in `SNAPSHOT_MINTING_API.md`

